<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>خط التعافي داخل التأهيل — 90 يوم</title>
  <meta name="description" content="خط زمني تفاعلي لمدة 90 يوم داخل برنامج التأهيل، يوضح التغيّرات الأسبوعية وكيف تدعم العائلة دون ضغط." />
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569;
      --accent:#22c55e; --accent-2:#06b6d4; --line:#e2e8f0; --shadow:0 10px 30px rgba(2,6,23,.08);
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Kufi Arabic, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 50% -10%, #eefbf7 0%, var(--bg) 60%);
      color:var(--text);
    }
    .container{max-width:1000px; padding:24px; margin:0 auto;}
    header{display:flex; gap:16px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;}
    .title{display:flex; gap:12px; align-items:center;}
    .logo{width:42px; height:42px; border-radius:12px; background:linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: var(--shadow); position:relative}
    .logo:after{content:""; position:absolute; inset:6px; border-radius:10px; background:rgba(255,255,255,.35)}
    h1{font-size:clamp(20px,4vw,28px); margin:0;}
    .lead{color:var(--muted); line-height:1.7; margin-top:6px;}
    .controls{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .chip{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:8px 12px; box-shadow: var(--shadow);}
    .chip input{border:none; outline:none; width:80px; font-size:16px; background:transparent; text-align:center;}
    .btn{border:none; background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; box-shadow: var(--shadow); font-weight:600}
    .btn.ghost{background:#fff; color:var(--text); border:1px solid var(--line)}
    .timeline-card{margin-top:20px; background:var(--card); border:1px solid var(--line); border-radius:18px; padding:18px; box-shadow: var(--shadow)}
    .bar-wrap{position:relative; height:14px; background:linear-gradient(90deg,#e5e7eb,#f1f5f9); border-radius:999px; overflow:hidden;}
    .bar .fill{position:absolute; inset:0; width:0%; background:linear-gradient(90deg, #9ae6b4, #86efac, #67e8f9); box-shadow: inset 0 0 10px rgba(34,197,94,.35)}
    .markers{position:relative; margin-top:28px; overflow-x:auto; padding-bottom:10px; scrollbar-width:thin; scrollbar-color:#cbd5e1 transparent;}
    .marker{--size:24px; position:absolute; top:0; translate:-50% 0; width:var(--size); height:var(--size); border-radius:999px; border:3px solid #fff; outline:2px solid var(--accent-2); background:#0ea5e9; cursor:pointer; flex:0 0 auto}
    .marker .dot{position:absolute; inset:6px; border-radius:999px; background:#fff}
    .marker.active{background:#22c55e; outline-color:#22c55e}
    .marker:hover{transform:scale(1.04)}
    .marker-label{position:absolute; top:36px; translate:-50% 0; font-size:12px; color:var(--muted); text-align:center; width:120px; pointer-events:none}
    .legend{display:flex; gap:12px; align-items:center; margin-top:16px; color:var(--muted); font-size:14px}
    .legend .swatch{width:14px;height:14px;border-radius:999px;background:linear-gradient(90deg, #9ae6b4, #67e8f9); border:1px solid #a7f3d0}
    .milestone-panel{margin-top:18px; background:#f9fafb; border:1px solid var(--line); border-radius:14px; padding:14px}
    .milestone-title{font-weight:700; margin:0 0 8px 0}
    .milestone-badges{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px}
    .badge{font-size:12px; padding:4px 8px; border-radius:12px; background:#ecfeff; border:1px solid #cffafe}
    .section{margin:8px 0}
    .section h3{margin:0 0 6px 0; font-size:14px; color:#0f766e}
    .section p{margin:0; color:#0b1324; line-height:1.8}
    .footer{margin:26px 0 8px; color:var(--muted); font-size:12px}
    noscript ul{line-height:1.9}
    @media (max-width:640px){
      .marker{--size:20px}
      .marker-label{width:72px; font-size:11px; top:30px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>خط التعافي داخل التأهيل — 90 يوم</h1>
          <p class="lead">نسخة مخصصة لوضع <strong>برنامج تأهيلي داخلي لمدة 90 يومًا</strong>؛ تُظهِر ما يتغيّر أسبوعيًا وكيف يمكن للعائلة أن تدعم دون ضغط.</p>
        </div>
      </div>
      <div class="controls" role="group" aria-label="أدوات">
        <div class="chip" title="أدخل عدد الأيام داخل البرنامج">
          <span>اليوم داخل البرنامج:</span>
          <input id="daysInput" type="number" min="0" max="90" inputmode="numeric" placeholder="0" aria-label="عدد الأيام منذ بدء التأهيل" />
        </div>
        <button class="btn" id="applyDays">حدّد موقعي الآن</button>
        <button class="btn ghost" id="printBtn" title="حفظ أو طباعة">حفظ PDF/طباعة</button>
      </div>
    </header>

    <section class="timeline-card" aria-labelledby="tl-title">
      <h2 id="tl-title" style="margin:0 0 12px 0; font-size:18px">شريط التقدّم</h2>
      <div class="bar-wrap" aria-hidden="true">
        <div class="bar"><div class="fill" id="fill"></div></div>
      </div>
      <div class="markers" id="markers" aria-label="معالم الوقت"></div>
      <div class="legend"><span class="swatch" aria-hidden="true"></span> <span>من أول الأيام داخل التأهيل ⟵ إلى إتمام 90 يومًا وخطة ما بعد الخروج</span></div>

      <div class="milestone-panel" id="panel" aria-live="polite">
        <p style="margin:0; color:var(--muted)">اضغط/اضغطي على أي نقطة لمعرفة ما يتغيّر خلال تلك المرحلة، وماذا يمكن للعائلة فعله باحترام لحدود البرنامج.</p>
      </div>
    </section>

    <footer class="footer">
      <div>تنبيه: هذه معلومات داعمة عامة ولا تُغني عن خطتك العلاجية أو توصيات فريق المركز. عند الطوارئ أو أفكار أذى، الرجاء التواصل فورًا مع الفريق المعالج أو خدمات الطوارئ.</div>
    </footer>

    <noscript>
      <h3>نسخة مبسطة (بدون تفاعل):</h3>
      <ul>
        <li>اليوم 1–3: التقييم والأمان.</li>
        <li>الأيام 4–7: إزالة السموم والنوم.</li>
        <li>الأسبوع 2: تقلب المزاج والرغبات.</li>
        <li>الأسبوع 3–4: وضوح وروتين.</li>
        <li>الأسبوع 5–6: مهارات ومحفزات.</li>
        <li>الأسبوع 7–8: علاقات وتواصل.</li>
        <li>الأسبوع 9–10: معنى ومكافآت صحية.</li>
        <li>الأسبوع 11–12: خطة ما بعد الخروج.</li>
      </ul>
    </noscript>
  </div>

  <script>
  // ————— بيانات المعالم (90 يوم تأهيلي) —————
  const milestones = [
    { id:'d1-3', label:'اليوم 1–3: التقييم والأمان', days:3, badges:['استقبال','سلامة'],
      changes:`التعرّف على الفريق والقوانين، تأمين النوم والطعام، بداية خفوت آثار التعاطي. قد توجد أعراض انسحاب وتقلّب مزاج.`,
      family:`رسائل قصيرة مطمئنة مع احترام الخصوصية: «نثق بك، اهتم بنفسك، نحن هنا عند الحاجة». اسألوا المركز عن سياسات الاتصالات والزيارات.`
    },
    { id:'w1', label:'الأيام 4–7: إزالة السموم والنوم', days:7, badges:['انسحاب','نوم'],
      changes:`تحسّن تدريجي في النوم والشهية، الرغبات ترتفع ثم تهدأ على فترات.`,
      family:`تجنّب الأسئلة الثقيلة. أرسلوا كلمات دعم فقط (إن كانت الاتصالات مسموحة). لا نقاشات عن الماضي الآن.`
    },
    { id:'w2', label:'الأسبوع 2: تقلب المزاج والرغبات', days:14, badges:['مزاج','رغبات'],
      changes:`الدماغ يعيد المعايرة؛ تقل الضبابية ببطء لكن المشاعر قد تتأرجح.`,
      family:`ثبّتوا روتين مكالمات قصير (إن وُجد). استخدموا عبارات تقدير: «فخورين فيك على استمرارك». ابتعدوا عن اللوم.`
    },
    { id:'w3-4', label:'الأسبوع 3–4: وضوح وروتين', days:28, badges:['وضوح','عادات'],
      changes:`تفكير أوضح، القدرة على الالتزام بالروتين العلاجي أعلى.`,
      family:`احضروا جلسات أسرية إن توفرت. اتفقوا على حدود صحية (مالية/اتصالية) بدعم الفريق العلاجي.`
    },
    { id:'w5-6', label:'الأسبوع 5–6: مهارات ومحفزات', days:42, badges:['مهارات','محفزات'],
      changes:`تعلّم مهارات التعامل مع المحفزات والضغط، تحسّن التركيز.`,
      family:`شاركوا في وضع قائمة «محفزات يجب تجنبها بعد الخروج». ساعدوا في ترتيب هوية شخصية بلا مواد.`
    },
    { id:'w7-8', label:'الأسبوع 7–8: علاقات وتواصل', days:56, badges:['علاقات','تواصل'],
      changes:`تحسّن التواصل والقدرة على إصلاح العلاقات، مزاج أكثر استقرارًا.`,
      family:`مارسوا تواصلًا غير عنيف: استمعوا أولًا، اسألوا عن الاحتياجات، وتجنّبوا التحقيق.`
    },
    { id:'w9-10', label:'الأسبوع 9–10: معنى ومكافآت صحية', days:70, badges:['هدف','مكافآت'],
      changes:`استعادة الإحساس بالمعنى، اهتمام بهوايات ومكافآت طبيعية.`,
      family:`خططوا لمكافآت صحية (نزهة/عشاء عائلي) بدل الهدايا المالية. استمروا بالحدود.`
    },
    { id:'w11-12', label:'الأسبوع 11–12 (حتى 90 يوم): خطة ما بعد الخروج', days:90, badges:['خطة','منع الانتكاس'],
      changes:`بناء خطة متابعة: مجموعات دعم، علاج فردي، سكن داعم عند الحاجة.`,
      family:`ثبّتوا خطة 30/60/90 يوم بعد الخروج: مواعيد، نقل، أدوية (إن وُجدت)، أدوار كل فرد عند الأزمات، وأرقام الطوارئ.`
    }
  ];

  // ————— عناصر الواجهة —————
  const markersWrap = document.getElementById('markers');
  let trackEl = null;
  const panel = document.getElementById('panel');
  const fill = document.getElementById('fill');
  const daysInput = document.getElementById('daysInput');
  const applyBtn = document.getElementById('applyDays');
  const printBtn = document.getElementById('printBtn');

  // ————— إعدادات المدى —————
  const totalDays = 90; // مدة البرنامج
  function daysToPercent(d){
    const v = Math.max(0, Math.min(totalDays, d));
    return (v/totalDays)*100;
  }

  // ————— بناء العلامات (مع مسار قابل للسحب) —————
  function renderMarkers(){
    markersWrap.innerHTML = '';

    trackEl = document.createElement('div');
    trackEl.className = 'track';
    trackEl.style.position = 'relative';
    trackEl.style.height = '60px';

    const wrapW = markersWrap.clientWidth || 360;
    const minW = Math.max(1200, Math.floor(wrapW * 1.8));
    trackEl.style.minWidth = minW + 'px';

    milestones.forEach(m => {
      const percent = daysToPercent(m.days);
      const marker = document.createElement('button');
      marker.className = 'marker';
      marker.style.left = percent + '%';
      marker.type = 'button';
      marker.setAttribute('aria-label', m.label);
      marker.dataset.id = m.id;
      marker.innerHTML = '<span class="dot" aria-hidden="true"></span>';
      marker.addEventListener('click', ()=> showMilestone(m.id, true));

      const label = document.createElement('div');
      label.className = 'marker-label';
      label.textContent = m.label;
      label.style.left = percent + '%';

      trackEl.appendChild(marker);
      trackEl.appendChild(label);
    });

    markersWrap.appendChild(trackEl);
  }

  // ————— عرض بطاقة المعلم —————
  function showMilestone(id, fromClick=false){
    document.querySelectorAll('.marker').forEach(el => el.classList.remove('active'));
    const data = milestones.find(x => x.id === id) || milestones[0];
    const currentMarker = [...document.querySelectorAll('.marker')].find(el => el.dataset.id === data.id);
    if(currentMarker) currentMarker.classList.add('active');

    panel.innerHTML = `
      <h3 class="milestone-title">${data.label}</h3>
      <div class="milestone-badges">${data.badges.map(b=>`<span class="badge">${b}</span>`).join('')}</div>
      <div class="section">
        <h3>ما الذي يتغيّر عادةً؟</h3>
        <p>${data.changes}</p>
      </div>
      <div class="section">
        <h3>كيف تدعم العائلة؟</h3>
        <p>${data.family}</p>
      </div>
      <div class="section" style="font-size:12px;color:#64748b; margin-top:12px">ملحوظة: الالتزامات والقواعد تختلف حسب المركز؛ التزم بتوجيهات فريقك العلاجي.</div>
    `;

    if(fromClick){ setFillToDays(data.days); }
  }

  // ————— ملء شريط التقدّم —————
  function setFillToDays(d){
    const p = daysToPercent(d);
    fill.style.width = p + '%';
    try{ localStorage.setItem('rehab_days', String(d)); }catch(e){}
    snapToNearest(d);
  }

  function snapToNearest(d){
    let closest = milestones[0];
    let best = Infinity;
    milestones.forEach(m => {
      const diff = Math.abs(m.days - d);
      if(diff < best){ best = diff; closest = m; }
    });
    showMilestone(closest.id, false);
  }

  // ————— أحداث الواجهة —————
  applyBtn.addEventListener('click', () => {
    const d = Number(daysInput.value || 0);
    if(Number.isFinite(d) && d >= 0){ setFillToDays(d); }
  });
  daysInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ applyBtn.click(); }
  });
  printBtn.addEventListener('click', () => window.print());

  // ————— تحجيم ديناميكي —————
  let resizeTimer;
  window.addEventListener('resize', ()=>{
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(renderMarkers, 120);
    try{
      const active = document.querySelector('.marker.active') || document.querySelector('.marker');
      if(active){
        const rect = active.getBoundingClientRect();
        const wrapRect = markersWrap.getBoundingClientRect();
        const offset = (rect.left + rect.width/2) - (wrapRect.left + wrapRect.width/2);
        markersWrap.scrollLeft += offset;
      }
    }catch(e){}
  });

  // ————— تهيئة —————
  renderMarkers();
  let stored = 0;
  try{ stored = Number(localStorage.getItem('rehab_days')||0) || 0; }catch(e){}
  if(stored>0){ daysInput.value = stored; setFillToDays(stored); }
  else { setFillToDays(0); showMilestone(milestones[0].id); }

  // ————— اختبارات بسيطة (Smoke Tests) —————
  (function tests(){
    try {
      console.assert(typeof renderMarkers === 'function', 'renderMarkers missing');
      console.assert(typeof daysToPercent === 'function', 'daysToPercent missing');
      console.assert(Array.isArray(milestones) && milestones.length > 0, 'milestones not defined');
      console.assert(daysToPercent(0) === 0, '0 days → 0%');
      console.assert(Math.abs(daysToPercent(totalDays) - 100) < 0.0001, 'totalDays → 100%');
      const mid = daysToPercent(totalDays/2);
      console.assert(Math.abs(mid - 50) < 0.001, 'midpoint ≈ 50%');
      console.log('✅ Smoke tests passed');
    } catch (e) {
      console.error('❌ Tests failed:', e);
    }
  })();
  </script>
</body>
</html>
